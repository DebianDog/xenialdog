#!/bin/bash



pidrox="`ps -eo pid,cmd | grep -v grep | grep "rox -p ${HOME}/.config/rox.sourceforge.net/ROX-Filer/pinbd-OB" | awk '{ print $1 }'`"
pidpcman="`ps -eo pid,cmd | grep -v grep | grep "pcmanfm --desktop" | awk '{ print $1 }'`"
deskpcman="`wmctrl -lx | awk '{ print $5 }' | grep pcmanfm`"
pidlxpanel="`ps -eo pid,cmd | grep -v grep | grep "lxpanel" | awk '{ print $1 }'`"

	if  [ "$pidrox" ]; then
exitfn () {
mv -f $HOME/.config/nitrogen/bg-saved.cfg.bak $HOME/.config/nitrogen/bg-saved.cfg
}
trap "exitfn" 1 2 15
nitrogen &
mv -f $HOME/.config/nitrogen/bg-saved.cfg $HOME/.config/nitrogen/bg-saved.cfg.bak
while true; do

BACK="$(grep "file=" $HOME/.config/nitrogen/bg-saved.cfg 2> /dev/null | sed 's#file=##')"
MODE="$(grep "mode=" $HOME/.config/nitrogen/bg-saved.cfg 2> /dev/null | sed 's#mode=##')"

BACKDROP=$(grep 'backdrop style' $HOME/.config/rox.sourceforge.net/ROX-Filer/pinbd-OB)


if [[ "$OLDBACK" != "$BACK" ]] || [[ "$OLDMODE" != "$MODE" ]]; then
[ "$MODE" = "0" ] && OPTION="Scaled"
[ "$MODE" = "5" ] && OPTION="Stretched"
[ "$MODE" = "4" ] && OPTION="Stretched"
[ "$MODE" = "3" ] && OPTION="Stretched"
[ "$MODE" = "2" ] && OPTION="Centred"
[ "$MODE" = "1" ] && OPTION="Tiled"

	if [ "$MODE" ] &&  [ "$BACK" ]; then
sed -i "s#$BACKDROP#<backdrop style="'"'$OPTION'"'">$BACK</backdrop>#" $HOME/.config/rox.sourceforge.net/ROX-Filer/pinbd-OB
/usr/bin/rox -p $HOME/.config/rox.sourceforge.net/ROX-Filer/pinbd-OB
	fi
fi

OLDBACK=$BACK
OLDMODE=$MODE
sleep 2

if [ ! "`pidof nitrogen`" ]; then
mv -f $HOME/.config/nitrogen/bg-saved.cfg.bak $HOME/.config/nitrogen/bg-saved.cfg
exit
fi
done

	elif [ "$deskpcman" ]; then
exitfn () {
[ "`pidof wbar`" ] && killall wbar && wbar &
}
trap "exitfn" 1 2 15
nitrogen &
mv -f $HOME/.config/nitrogen/bg-saved.cfg $HOME/.config/nitrogen/bg-saved.cfg.bak
while true; do
set -x
BACK="$(grep "file=" $HOME/.config/nitrogen/bg-saved.cfg 2> /dev/null | sed 's#file=##')"
MODE="$(grep "mode=" $HOME/.config/nitrogen/bg-saved.cfg 2> /dev/null | sed 's#mode=##')"
if [[ "$OLDBACK" != "$BACK" ]] || [[ "$OLDMODE" != "$MODE" ]]; then

[ "$MODE" = "0" ] && OPTION="screen"
[ "$MODE" = "5" ] && OPTION="crop"
[ "$MODE" = "4" ] && OPTION="stretch"
[ "$MODE" = "3" ] && OPTION="stretch"
[ "$MODE" = "2" ] && OPTION="center"
[ "$MODE" = "1" ] && OPTION="tile"

[ "$BACK" ] && pcmanfm -w "$BACK"
if [ "$MODE" ]; then
pcmanfm --wallpaper-mode=$OPTION
else
pcmanfm --wallpaper-mode=stretch
fi

[ "`pidof wbar`" ] && killall wbar && wbar &
#killall wbar 2> /dev/null
#wbar &
fi
OLDBACK=$BACK
OLDMODE=$MODE

sleep 2
if [ ! "`pidof nitrogen`" ]; then
mv -f $HOME/.config/nitrogen/bg-saved.cfg.bak $HOME/.config/nitrogen/bg-saved.cfg
exit
fi
done

	else
nitrogen &
	fi

exit











